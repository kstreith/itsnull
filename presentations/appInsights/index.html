<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Insightful Logging with Azure Application Insights</title>

		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/monokai.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<h3>Insightful Logging with Azure Application Insights</h3>
					<h4>October 2019</h4>
					<h4>Follow along at:</h4>
					<p><a href="https://itsnull.com/presentations/appInsights/">https://itsnull.com/presentations/appInsights/</a></p>
					<p>Kip Streithorst</p>
				</section>
				<section>
					<h4>Overview</h4>
					<ul>
						<li>ILogger</li>
						<li>Structured Logging</li>
						<li>Azure Application Insights</li>
					</ul>
				</section>
				<section>
					<h4>ILogger</h4>
					<ul>
						<li>Part of <a href="https://www.nuget.org/packages/Microsoft.Extensions.Logging.Abstractions/">Microsoft.Extensions.Abstractions</a> nuget</li>
						<li>ILogger.LogInformation("My custom message");</li>
						<li>Only an interface, implementations are provided in other assemblies</li>
						<li>Was built by ASP.Net Core team, but can be used in normal .net assemblies</li>
					</ul>
				</section>
				<section>
					<h4>Structured Logging</h4>
					<ul>
						<li>What does a logging abstraction get you?</li>
						<li>Historically, you log strings, e.g. Console.WriteLine</li>
						<li>With a logging abstraction, you can log to a database, windows event log, etc.</li>
						<li>But, you still just logged a string</li>
						<li>How do you search and act on logs faster? Do you parse strings constantly?</li>
					</ul>
				</section>	
				<section>
					<h4>Structured Logging (cont.)</h4>
					<ul>
						<li>Why not log a object with properties? e.g. JSON?</li>
						<li>Historically, that's always been possible, e.g. custom class with windows event log</li>
						<li>Really a custom class per message?</li>
						<li>Serilog came up with an interesting syntax</li>
					</ul>
				</section>		
				<section>
					<h4>Structured Logging (cont.)</h4>
					<ul>
						<li>Classic syntax - logs strings</li>
						<li>LogInformation(String.Format("Failed to set {0} to {1}", prop, value));</li>
						<li>LogInformation($"Failed to set {prop} to {value}");</li>
					</ul>
				</section>
				<section>
					<h4>Structured Logging (cont.)</h4>
					<ul>
						<li>Serilog Syntax - logs object</li>
						<li>LogInformation("Failed to set {prop} to {value}", prop, value);</li>
						<li>Logs {"prop": "age", "value": 27}</li>
						<li>Still positional like String.Format</li>
					</ul>
				</section>				
				<section>
					<h4>Structured Logging (cont.)</h4>
					<ul>
						<li>ILogger supports this syntax</li>
						<li>An implementation can either log an object or render object with template back to a string</li>
						<li>Now you can query easily and act on log data faster</li>
						<li>Always use the structured logging syntax</li>
					</ul>
				</section>	
				<section>
					<h4>Azure Application Insights</h4>
					<ul>
						<li>Cloud-based APM (Application Performance Management) tool</li>
						<li>Lots of features, I'll demo some of them</li>
						<li>Log storage solution with support for schema-less objects</li>
						<li>Billed on data ingest</li>
						<li>Data has an automatic retention period, default, 90 days</li>
					</ul>
				</section>	
				<section>
					<h4>Azure Application Insights</h4>
					<ul>
						<li>Telemetry Types</li>
						<li>Demos</li>						
						<li>How to create</li>
						<li>Configuring with ASP.NET Core</li>
					</ul>
				</section>							
				<section>
					<h4>App Insights - Telemetry Types</h4>
					<ul>
						<li>If we log objects, let's model the actual domain.</li>
						<li>PageView - url, duration</li>
						<li>Request - url, status code, duration</li>
						<li>Trace - message, severity</li>
						<li>Exception - type, stack trace</li>
						<li>Dependency - data, type, duration</li>
						<li>Metric - either single value or pre-aggregated</li>
					</ul>
				</section>
				<section>
					<h4>App Insights - Telemetry Types</h4>
					<ul>
						<li>A given operation includes multiple telemetry types</li>
						<li>Each telemetry type has an operation id, to correlate them together</li>
						<li>Each telemetry type supports custom key-value pairs, e.g. schema-less object</li>
					</ul>
				</section>	
				<section>
					<h4>App Insights - Telemetry</h4>
					<ul>
						<li>Send Telemetry from your VM or App to App Insights using their REST API</li>
						<li>MS provides a large number of libraries and tools that wrap the REST API</li>
						<li>Supports multiple languages, environments and platforms.</li>
					</ul>
				</section>
				<section>
					<h4>App Insights - DEMO</h4>
					<ul>
						<li>Demo Time!</li>
					</ul>
				</section>				
				<section>
					<h4>App Insights - Create</h4>
					<ul>
						<li>Use azure cli directly or from Cloud Shell</li>
						<pre><code data-trim>
							az monitor app-insights component create
							  --app demoApp
							  --location westus2
							  --resource-group demo-rg
						</code></pre>
					</ul>
				</section>	
				<section>
					<h4>App Insights for ASP.Net Core</h4>
					<ul>
						<li>Add nuget to your .csproj</li>
						<li>Use 2.7.1 or later or instructions won't be accurate</li>
						<pre><code class="xml" data-trim> 
							&lt;PackageReference
							  Include="Microsoft.ApplicationInsights.AspNetCore"
							  Version="2.8.0" /&gt;
						</code></pre>
					</ul>
				</section>	
				<section>
					<h4>App Insights for ASP.Net Core (cont.)</h4>
					<ul>
						<li>Update Startup.cs</li>
						<pre><code class="csharp" data-trim> 
							void ConfigureServices(IServiceCollection services)
							{
							  services.AddApplicationInsightsTelemetry(options =>
							  {
							    config.Bind("ApplicationInsights", options);
							  });
							}
						</code></pre>
					</ul>
				</section>	
				<section>
					<h4>App Insights for ASP.Net Core (cont.)</h4>
					<ul>
						<li>Update appsettings.json</li>
						<pre><code class="json" data-trim> 
						{
						  "ApplicationInsights": {
						    "InstrumentationKey": "KEY-GOES-HERE",
						    "EnableAdaptiveSampling": true
						  },
						}
						</code></pre>
					</ul>
				</section>	
				<section>
					<h4>App Insights for ASP.Net Core (cont.)</h4>
					<ul>
						<li>ILogger will only log warnings and errors to App Insights</li>
						<li>To fix, you have to remove hard-coded rule, put in Startup.cs</li>
						<pre><code class="csharp" data-trim> 
							services.PostConfigureAll&lt;LoggerFilterOptions&gt;(action =>
							  {
							    var matchingRule = action.Rules.SingleOrDefault(
								  x => x.ProviderName ==
							        typeof(ApplicationInsightsLoggerProvider).FullName);
							    if (matchingRule != null)
							    {
							      action.Rules.Remove(matchingRule);
							    }
							  });
						</code></pre>
					</ul>
				</section>
				<section>
					<h4>App Insights for ASP.Net Core (cont.)</h4>
					<ul>
						<li>If ILogger is logging everything to App Insights</li>
						<li>May want to turn down ASP.NET Core internal logging</li>
						<li>Edit appsettings.json</li>
						<pre><code class="json" data-trim> 
							"Logging": {
							  "LogLevel": {
							    "Default": "Debug",
							    "System": "Warning",
							    "Microsoft": "Warning"
							  }
							},
						</code></pre>
					</ul>
				</section>	
				<section>
					<h4>Customize App Insights Telemetry</h4>
					<ul>
						<li>Subclass TelemetryInitializerBase</li>
						<li>Used to initialize telemetry</li>
						<li>Register into DI</li>
						<li>services.AddSingleton&lt;ITelemetryInitializer, T&gt;();</li>
					</ul>
				</section>	
				<section>
					<h4>Customize App Insights Telemetry (cont.)</h4>
					<ul>
						<li>Implement ITelemetryProcessor</li>
						<li>Processes telemetry in a chain, last in chain sends to App Insights REST API</li>
						<li>Don't call next processor to prevent telemetry from going up</li>
						<li>Register into DI</li>
						<li>services.
							AddApplicationInsightsTelemetryProcessor&lt;T&gt;();</li>
					</ul>
				</section>																											
				<section>
					<h4>Recap</h4>
					<ul>
						<li>Use structured logging syntax, always</li>
						<li>LogInformation("Did not expect {field} to have {value}", key, dict[key]);</li>
					</ul>
				</section>
				<section>
					<h4>Recap (cont.)</h4>
					<ul>
						<li>App Insights billed on data ingest, configurable retention</li>
						<li>Live Metrics - with live filtering</li>
						<li>Waterfall view per operation</li>
						<li>Built-in dashboards</li>
						<li>Snapshot debugging a live application</li>
						<li>Telemetry customization</li>
					</ul>
				</section>	
				<section>
					<h4>Recap (cont.)</h4>
					<ul>
						<li>Features we did not see</li>
						<ul>
							<li>Alerts</li>
							<li>Notebooks and custom dashboards</li>
							<li>Front-end JS telemetry</li>
							<li>Application Map</li>
							<li>Smart detection</li>
							<li>Availability tests</li>
						</ul>
					</ul>
				</section>																								
				<section>
					<h4>Thanks, questions?</h4>
					<ul>
						<li>Thanks for attending</li>
						<li>Any Questions?</li>
						<p><a href="https://itsnull.com/presentations/appInsights/">https://itsnull.com/presentations/appInsights/</a></p>
					</ul>
				</section>
			</div>
		</div>

		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true }
				]
			});
		</script>
	</body>
</html>
