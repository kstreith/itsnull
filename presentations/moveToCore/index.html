<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Converting Web App to ASP.Net Core</title>
    
   <script type="text/javascript">
        var appInsights=window.appInsights||function(config){
            function r(config){t[config]=function(){var i=arguments;t.queue.push(function(){t[config].apply(t,i)})}}var t={config:config},u=document,e=window,o="script",s=u.createElement(o),i,f;for(s.src=config.url||"//az416426.vo.msecnd.net/scripts/a/ai.0.js",u.getElementsByTagName(o)[0].parentNode.appendChild(s),t.cookie=u.cookie,t.queue=[],i=["Event","Exception","Metric","PageView","Trace"];i.length;)r("track"+i.pop());return r("setAuthenticatedUserContext"),r("clearAuthenticatedUserContext"),config.disableExceptionTracking||(i="onerror",r("_"+i),f=e[i],e[i]=function(config,r,u,e,o){var s=f&&f(config,r,u,e,o);return s!==!0&&t["_"+i](config,r,u,e,o),s}),t
        }({
            instrumentationKey:"7835d8bd-cc2d-4cd1-ace6-04799eba844f"
        });
        
        window.appInsights=appInsights;
        appInsights.trackPageView();
    </script>
    
		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<meta name="description" content="Converting Web App to ASP.Net Core">
		<meta name="author" content="Kip Streithorst">
    
		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
        <section>
          <h3>Converting Web App to ASP.Net Core</h3>
          <h4>September 2016</h4>
          <h4>Follow along at:</h4>
          <p><a href="http://itsnull.com/">http://itsnull.com/</a></p>
          <p><a href="http://itsnull.com/presentations/moveToCore/">http://itsnull.com/presentations/moveToCore/</a></p>
          <p>
          <small>Created by <a href="http://itsnull.com">Kip Streithorst</a> / <a href="http://twitter.com/itsnull">@itsnull</a></small>
          </p>
        </section>
        <section>
          <h3>Goal</h3>
          <ul>
            <li>Have an simple existing web app (VS 2013 using WebAPI)</li>
            <li>Convert to ASP.Net Core and .NET Core</li>
            <li>Demo converted app running on Linux</li>
            <li>Code for original and converted app available:
            <a href="https://github.com/kstreith/ConvertingWebApiToAspNetCore">https://github.com/kstreith/ConvertingWebApiToAspNetCore</a></li>
          </ul>
        </section>
        <section>
          <h3>Starting App - DEMO</h3>
          <ul>
            <li>Chore tracking application, built during previous set of meetups</li>
            <li>WebAPI v2, VS 2013</li>
            <li>No MVC, has static HTML</li>
            <li>No database</li>
            <li>Has custom in-memory persistence w/ optional write to disk</li>
          </ul>
        </section>
        <section>
          <h3>What is ASP.Net Core?</h3>
          <ul>
            <li>Re-write of MVC and WebAPI</li>
            <li>Removes dependency on IIS and System.Web</li>
            <li>Merges WebAPI and MVC pipelines together, only one controller</li>
            <li>Higher performance in general, pay as you play performance model</li>
            <li>Runs on .NET Framework or .NET Core</li>            
          </ul>
        </section>
        <section>
          <h3>What is .Net Core?</h3>
          <ul>
            <li>Cross platform, open-source .NET runtime</li>
            <li>Runs on Linux, Mac OS X and Windows, supported by MS</li>
            <li>Doesn't have to install globally, smaller footprint</li>
            <li>Can run isolated and multiple versions side by side</li>
          </ul>
        </section>
        <section>
          <h3>Why not ASP.Net Core?</h3>
          <ul>
            <li>Web.config gone - IIS provided that</li>            
            <li>Manual conversion - MVC, WebAPI pipelines merged, new class names and namespaces.</li>
            <li>WebForms is not part of ASP.NET Core</li>
            <li>SignalR is missing in 1.0.0 release of ASP.Net Core</li>
          </ul>
        </section>
        <section>
          <h3>Why not .Net Core?</h3>
          <ul>
            <li>Slight changes - Reflection</li>
            <li>Removed - App Domains, Remoting, Binary serialization, Sandboxing</li>
            <li>Gone, but might come back - System.Data.DataTable, System.Drawing, XSD, XSLT, System.Net.Mail</li>
            <li>As of today, most NuGet packges may not run on it. This should improve over time.</li>
          </ul>
        </section>
        <section>
          <h3>So, why again?</h3>
          <ul>
            <li>More choices - choice of OS, choice of server</li>
            <li>Higher performance for ASP.Net Core</li>
            <li>Not at all tied to Visual Studio</li>
            <li>Smaller footprint, e.g. Docker containers</li>
            <li>Can be xcopy deployed, including .NET Core Runtime</li>
            <li>Still C#, still MVC, WebAPI pipeline with minor syntax changes</li>
          </ul>
        </section>
        <section>
          <h3>Convert to .NET Core?</h3>
          <ul>
            <li>.NET Core might effect every dependency you have</li>
            <li>EF Core replaces EF, Azure .NET SDK - not working, Oracle DB Drivers - not working</li>
            <li>Use MS Portability Analyzer to check your code and dependencies</li>
            <li>Download console app (ApiPort): <a href="https://github.com/Microsoft/dotnet-apiport/releases">https://github.com/Microsoft/dotnet-apiport/releases</a></li>
            <li>How to use video: <a href="https://www.youtube.com/watch?v=Ox7qpsRq2LM">https://www.youtube.com/watch?v=Ox7qpsRq2LM</a></li>
          </ul>
        </section>
        <section>
          <h3>Convert to .NET Core? Maybe not</h3>
          <ul>
            <li>ASP.Net Core will run on either .NET Core or .NET Framework</li>
            <li>My advice: port to ASP.Net Core first, then .NET Core</li>
            <li>Porting this way only affects one tier of your application</li>
            <li>For my presentation and web app, I'm porting both at the same time.</li>
          </ul>
        </section>
        <section>
          <h3>Converting to ASP.Net Core</h3>
          <ul>
            <li>Use VS 2015 Update 3, update Microsoft ASP.Net and Web Tools extension</li>
            <li>File -> New project in VS 2015
            <img src="images/NewProjectDialog.png" />
            </li>
            <li>Decide between .NET Framework or .NET Core, you can change your mind later</li>
          </ul>
        </section>
        <section>
          <h3>Converting to ASP.Net Core</h3>
          <ul>
            <li>Select WebAPI on the next screen for the template
            <img src="images/TemplateDialog.png" />            
            </li>
            <li>Demo template and discuss</li>
            <li>Demo in VS 2015, with IIS Express and console app</li>
            <li>Demo in VS Code</li>
            <li>Demo dotnet command-line</li>
          </ul>
        </section>
        <section>
          <h3>Converting to ASP.Net Core</h3>
          <ul>
            <li>Copy C# code from WebAPI project into new project</li>
            <li>ApiController class gone, HttpResponseException class gone</li>
            <li>New controller base class, exception gone, routing and model binding changed</li>
            <li>Found WebApiCompatShim, part of ASP.Net Core</li>
            <li>Contains ApiController, HttpResponseExceptionm, original routing, etc...</li>
          </ul>
        </section>
        <section>
          <h3>Shim or Not?</h3>
          <ul>
            <li>WebApiCompatShim makes transition much easier</li>
            <li>But new code is using a shim?</li>
            <li>Haven't researched a MVC shim or know if one is needed</li>
            <li>Decided to do 2 conversions: first with shim, second without shim</li>
          </ul>
        </section>
        <section>
          <h3>Shim or Not?</h3>
          <ul>
            <li>WebApiCompatShim makes transition much easier</li>
            <li>But new code is using a shim?</li>
            <li>Haven't researched a MVC shim or know if one is needed</li>
            <li>Decided to do 2 conversions: first with shim, second without shim</li>
          </ul>
        </section>
        <section>
          <h3>Enabling WebApiCompatShim</h3>
          <ul>
            <li>Add nuget package to project.json
            <pre>
"dependencies": {
  "Microsoft.AspNetCore.Mvc.WebApiCompatShim": "1.0.0",
}            
            </pre>
            </li>
            <li>Update Startup.cs, ConfigureServices method
            <pre><code class="cs">
public void ConfigureServices(IServiceCollection services) {
    //from this: services.AddMvc();
    //to this:
    services.AddMvc().AddWebApiConventions();
}
            </code></pre>
            </li>
          </ul>
        </section>        
        <section>
          <h3>Enabling WebApiCompatShim, Cont.</h3>
          <ul>
            <li>Update Startup.cs, Configure
            <pre><code class="cs">
public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory) {
  //from this: app.UseMvc();
  //to this:
  app.UseMvc(options => options.MapWebApiRoute("DefaultApi", "api/{controller}/{id?}"));
}
            </code></pre>            
            </li>
            <li>
            [Route] or [HttpGet], [HttpPost] attributes, moved to new namespace
            using Microsoft.AspNetCore.Mvc;
            </li>
          </ul>
        </section>
        <section>
          <h3>Compiling, but not MapPath</h3>
          <ul>
            <li>This app has custom persistence, requires HostingEnvironment.MapPath("/App_Data/") to locate App_Data folder</li>
            <li>That class is part of System.Web, which ASP.Net core no longer uses.</li>
            <li>Replaced with IHostingEnvironment.ContentRootFileProvider.
            GetFileInfo("/App_Data").PhysicalPath</li>
          </ul>
        </section>
        <section>
          <h3>Fixing MapPath</h3>
          <ul>
            <li>IHostingEnvironment is interface that my ChoreRepository needs</li>
            <li>So, ChoreRepository has to be configured to use ASP.Net Core Dependency Injection</li>
            <li>Update ChoreRepository constructor to take IHostingEnvironment parameter</li>
            <li>ChoreRepository previous had .GetInstance() method, convert all Controllers to receive
            ChoreRepository as constructor parameter</li>            
          </ul>
        </section>
        <section>
          <h3>Fixing MapPath, Cont.</h3>
          <ul>
            <li>Enlist ChoreRepository into DI system in Startup.cs
            <pre><code class="cs">
public void ConfigureServices(IServiceCollection services) {
  services.AddSingleton&lt;ChoreRepository, ChoreRepository&gt;();
}
            </code></pre>            
            </li>
          </ul>
        </section>
        <section>
          <h3>Api works</h3>
          <ul>
            <li>Success! Compiles and Runs!</li>
            <li>At this point, Api appears to work when tested manually</li>
            <li>Need static HTML and JS now</li>
          </ul>
        </section>
        <section>
          <h3>Add Static HTML, JS</h3>
          <ul>
            <li>Content has to be in wwwroot/ folder</li>
            <li>Move css/, fonts/, images/, scripts/, index.html into wwwroot/ folder</li>
            <li>However, still doesn't work</li>
          </ul>
        </section>
        <section>
          <h3>Enable Static Serving</h3>
          <ul>
            <li>Must enable static file serving</li>
            <li>Add nuget package to project.json
            <pre>
"dependencies": {
  "Microsoft.AspNetCore.StaticFiles": "1.0.0",
}            
            </pre>
            </li> 
          </ul>
        </section>
        <section>
          <h3>Enable Static Serving, Cont.</h3>
          <ul>
            <li>Update Startup.cs, Configure
            <pre><code class="cs">
public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory) {
  app.UseStaticFiles();
}
            </code></pre>            
            </li>          
            <li>http://localhost:5000/index.html works</li>
            <li>http://localhost:5000/ doesn't</li>
          </ul>
        </section>
        <section>
          <h3>Enable default routing</h3>
          <ul>
            <li>Must enable default routing</li>
            <li>Update Startup.cs, Configure
            <pre><code class="cs">
public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory) {
  app.UseDefaultFiles();
  //must be before app.UseStaticFiles
}
            </code></pre>            
            </li> 
            <li>Now, http://localhost:5000/ works</li>
          </ul>
        </section>
        <section>
          <h3>Working???</h3>
          <ul>
            <img src="images/AppNotReallyWorking.png" />
            <li>This probably doesn't count</li>
          </ul>
        </section>
        <section>
          <h3>JSON Serialization</h3>
          <ul>
            <li>WebAPI would serialize a C# class to JSON with the exact same casing</li>
            <li>ASP.Net Core will serialize as JS case by default, so:
            <li>class Person { string FirstName {get; set;} }</li>
            <li>will serialize as "{firstName: ""}" with ASP.Net Core</li>
            <li>This is a breaking change</li>
          </ul>
        </section>
        <section>
          <h3>Fix JSON serialization</h3>
          <ul>
            <li>So, either update all your JS code</li>
            <li>And any clients that use your api</li>
            <li>Or, have ASP.Net Core revert to prior behavior</li>
          </ul>
        </section>
        <section>
          <h3>Fix JSON serialization, Cont.</h3>
          <ul>
            <li>Update Startup.cs, ConfigureServices method
            <pre><code class="cs">
public void ConfigureServices(IServiceCollection services) {
  //append AddJsonOptions to AddMvc() call
  services.AddMvc().AddJsonOptions(opt => {
      var res = opt.SerializerSettings.ContractResolver as DefaultContractResolver;
      if (res != null) {
          res.NamingStrategy = null;
      }
  });
}
            </code></pre>
            </li>
          </ul>
        </section>
        <section>
          <h3>It Works!</h3>
          <ul>
            <img src="images/AppWorking.png" />
          </ul>
        </section>
        <section>
          <h3>Model Binding Bug</h3>
          <ul>
            <li>Two of my api calls don't work</li>
            <li>I get a 415 Unsupported Media Type response</li>
            <li>Why?</li>
          </ul>
        </section>
        <section>
          <h3>Model Binding Bug, Cont.</h3>
          <ul>
            <li>Two ways to send complex data from client to server</li>
            <li><pre><code class="js">//BODY:
$.ajax({
  type: 'POST',
  url: '/someUrl',
  contentType: 'application/json',
  data: JSON.stringify({ Name: 'Jane', Age: 2 })
});
//FORM:
$.ajax({
  type: 'POST',
  url: '/someUrl',
  data: { Name: 'Jane', Age: 2 }
});
            </code></pre>
            </li>      
          </ul>
        </section>
        <section>
          <h3>Model Binding Bug, Cont.</h3>
          <ul>
            <li>WebAPI would check both form and body when model binding complex types</li>
            <li>ASP.Net Core will only check one of them</li>
            <li>Must use [FromBody] or [FromFrom] attribute on method parameter</li>
            <li>In-depth blog post: <a href="http://andrewlock.net/model-binding-json-posts-in-asp-net-core/">http://andrewlock.net/model-binding-json-posts-in-asp-net-core/</a></li>           
          </ul>
        </section>
        <section>
          <h3>Model Binding Bug, Cont.</h3>
          <ul>
            <li>ASP.Net Core default if you don't do anything is assume you typed [FromForm]</li>
            <li>However, using WebApiCompatShim changes the default to [FromBody]</li>
            <li>Application JS that caused server error was submitting using Form, so I had to 
            add [FromFrom] to that C# controller method</li>
          </ul>
        </section>
        <section>
          <h3>Demo on Linux</h3>
          <ul>
            <li>Copy code over</li>
            <li>dotnet restore</li>
            <li>dotnet run</li>
            <li>http://localhost:5000/</li>
          </ul>
        </section>
        <section>
          <h3>Without the shim</h3>
          <ul>
            <li>Remove WebApiCompatShim from project.json and Startup.cs</li>
            <li>Must add [FromBody] to controller methods that take complex types, e.g. POST, PUT</li>
            <li>Controller no longer has a subclass at all, previously ApiController</li>
          </ul>
        </section>
        <section>
          <h3>Without the shim, Cont.</h3>
          <ul>
            <li>Add [Route("api/{controller}")] to each controller class</li>
            <li>Add [HttpGet()] to /api/controller/ methods</li>
            <li>Add [HttpGet("{id}")] to /api/controller/id/ methods</li>
            <li>Add [HttpPost()] to post methods, e.g. create</li>
            <li>Add [HttpPut("{id}")] to put methods, e.g. update</li>
            <li>Add [HttpDelete("{id}")] to delete methods</li>
          </ul>
        </section>
        <section>
          <h3>Without the shim, Cont.</h3>
          <ul>
            <li>You might have to fix old [Route] attributes</li>
            <li>Previously, I had [Route("api/chores/complete")]</li>
            <li>But now that controller had [Route("api/{controller}"] added</li>
            <li>The two urls combined into /api/chores/api/chores/complete</li>
            <li>Updated existing attribute to [Route("complete")]</li>
          </ul>
        </section>
        <section>
          <h3>Without the shim, Cont.</h3>
          <ul>
            <li>Had to fix usage of HttpResponseException</li>
            <li>Created three custom subclasses of Exception: DataConflictException, DataMissingException and InvalidRequestException</li>
            <li>Also switched to using built-in TimeoutException</li>
            <li>Had to write custom filter for ASP.Net Core pipeline</li>
          </ul>
        </section>
        <section>
          <h3>Without the shim, Cont.</h3>
          <ul>
            <li>Converts exception into status code response</li>
            <li><pre><code class="cs">public override void OnException(ExceptionContext context) {
    var statusCode = HttpStatusCode.OK;
    if (context.Exception is DataConflictException) {
        statusCode = HttpStatusCode.Conflict;
    } else if (context.Exception is DataMissingException) {
        statusCode = HttpStatusCode.NotFound;
    } else if (context.Exception is InvalidRequestException) {
        statusCode = HttpStatusCode.BadRequest;
    } else if (context.Exception is TimeoutException) {
        statusCode = HttpStatusCode.RequestTimeout;
    }            
    if (statusCode != HttpStatusCode.OK) {
        context.ExceptionHandled = true;
        context.Result = new StatusCodeResult((int)statusCode);
    } 
}     
            </code></pre>            
            </li>
          </ul>
        </section>
        <section>
          <h3>Without the shim, Cont.</h3>
          <ul>
            <li>Must register custom filter into pipeline</li>
            <li>Update Startup.cs, ConfigureServices method
            <pre><code class="cs">
public void ConfigureServices(IServiceCollection services) {
  services.AddMvc(opt => {
      opt.Filters.Add(new DataExceptionFilterAttribute());
  });
}
            </code></pre>
            </li>            
          </ul>
        </section>
        <section>
          <h3>Demo on Linux</h3>
          <ul>
            <li>Copy code over</li>
            <li>VS code works just as well</li>
            <li>code .</li>
            <li>Debug with VS code</li>
            <li>http://localhost:5000/</li>
          </ul>
        </section>
        <section>
          <h3>All code is available</h3>
          <ul>
            <li><a target="_blank" href="https://github.com/kstreith/ConvertingWebApiToAspNetCore">https://github.com/kstreith/ConvertingWebApiToAspNetCore</a></li>
            <li>OriginalWebApi/ folder runs in VS 2013</li>
            <li>ConvertedUsingShim/ folder runs in VS Code, dotnet command line, VS 2015 Update 3</li>
            <li>ConvertedFully/ folder</li>
            <li>Feel free to diff directories to see what was changed</li>
          </ul>
        </section>
        <section>
          <h3>Thanks, Any Questions?</h3>
          <ul>
            <li>Kip Streithorst</li>
            <li>Sample Code: <a target="_blank" href="https://github.com/kstreith/ConvertingWebApiToAspNetCore">https://github.com/kstreith/ConvertingWebApiToAspNetCore</a></li>
            <li>Twitter: <a target="_blank" href="http://twitter.com/itsnull">@itsnull</a></li>
            <li>Blog: <a target="_blank" href="http://itsnull.com/">http://itsnull.com/</a></li>
            <li>Presentation: <a target="_blank" href="http://itsnull.com/presentations/moveToCore/">http://itsnull.com/presentations/moveToCore/</a>
          </ul>
        </section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				history: true,

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
    
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46954011-1', 'auto');
  ga('send', 'pageview');

</script>
    
	</body>
</html>
